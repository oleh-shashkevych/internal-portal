const jsonData = {
	users: [
		{
			user: 'Val',
			data: {
				year_2025: {
					jan: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1, 2,
					],
					feb: [
						5, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7,
					],
					mar: [
						1, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1,
					],
					apr: [
						8, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1, 2,
					],
					may: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1,
					],
					jun: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1, 2,
					],
					jul: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1,
					],
					aug: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1, 2,
					],
					sep: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1,
					],
					oct: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1, 2,
					],
					nov: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1,
					],
					dec: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1,
					],
				},
				year_2024: {
					dec: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1,
					],
				},
				year_2023: {
					oct: [
						2, 3, 5, 6, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 3, 4, 5, 2, 5, 6, 2,
						3, 5, 4, 2, 7, 5, 1, 2,
					],
				},
				year_2022: {},
				year_2021: {},
				year_2020: {},
				year_2019: {},
				year_2018: {},
			},
		},
		{
			user: 'Tanya',
			data: {
				year_2025: {
					jan: [
						3, 5, 6, 2, 7, 4, 1, 6, 5, 3, 2, 4, 1, 6, 2, 7, 4, 5, 6, 3, 7, 2, 5,
						1, 3, 7, 4, 6, 2, 5, 1,
					],
					feb: [
						5, 7, 3, 2, 6, 4, 1, 5, 2, 7, 3, 6, 1, 4, 2, 5, 3, 7, 4, 2, 6, 1, 7,
						5, 3, 4, 2, 6,
					],
					mar: [
						1, 6, 3, 7, 2, 4, 5, 3, 6, 1, 4, 2, 7, 5, 3, 4, 6, 2, 7, 1, 5, 6, 3,
						2, 4, 7, 5, 6, 1,
					],
					apr: [
						2, 5, 4, 7, 3, 1, 6, 2, 5, 4, 7, 1, 6, 3, 2, 4, 5, 7, 6, 1, 3, 2, 6,
						4, 7, 5, 3,
					],
					may: [
						3, 6, 2, 4, 1, 5, 7, 3, 2, 6, 5, 1, 4, 7, 6, 2, 5, 4, 1, 7, 3, 6, 5,
						2, 4, 7, 1, 6, 3, 2, 5,
					],
					jun: [
						7, 1, 4, 3, 6, 5, 2, 7, 6, 3, 5, 2, 4, 1, 7, 6, 5, 3, 2, 4, 7, 1, 6,
						2, 5, 4, 3, 7, 1,
					],
					jul: [
						6, 3, 1, 5, 2, 7, 4, 6, 1, 3, 2, 7, 4, 5, 6, 1, 2, 3, 7, 5, 6, 4, 2,
						1, 3, 7, 5,
					],
					aug: [
						4, 6, 2, 7, 3, 1, 5, 4, 2, 6, 3, 1, 7, 5, 6, 2, 3, 7, 4, 5, 1, 6, 7,
						3, 2, 5, 4, 1,
					],
					sep: [
						7, 3, 5, 6, 1, 4, 2, 7, 3, 6, 4, 5, 2, 1, 7, 6, 5, 4, 3, 2, 1, 7, 5,
						6, 3, 2, 4, 1,
					],
					oct: [
						1, 6, 3, 7, 5, 2, 4, 6, 3, 5, 1, 2, 7, 4, 6, 3, 1, 5, 7, 2, 4, 6, 1,
						3, 5, 2, 7,
					],
					nov: [
						5, 3, 1, 6, 7, 4, 2, 3, 5, 1, 7, 6, 4, 2, 5, 3, 6, 7, 2, 4, 1, 5, 3,
						7, 6, 4, 2,
					],
					dec: [
						7, 1, 5, 4, 2, 3, 6, 7, 1, 5, 6, 3, 4, 2, 7, 5, 6, 4, 1, 3, 2, 7, 6,
						5, 1, 4, 2, 3,
					],
				},
				year_2024: {
					dec: [
						1, 4, 5, 2, 7, 3, 6, 1, 7, 5, 2, 6, 3, 4, 7, 2, 5, 3, 1, 6, 4, 7, 2,
						6, 5, 3, 1, 4, 2,
					],
				},
				year_2023: {
					oct: [
						6, 2, 5, 1, 4, 7, 3, 6, 4, 5, 1, 2, 7, 3, 6, 4, 2, 5, 7, 1, 3, 6, 4,
						2, 7, 1, 5,
					],
				},
				year_2022: {},
				year_2021: {},
				year_2020: {},
				year_2019: {},
				year_2018: {},
			},
		},
	],
};

// Глобальные переменные для выбранного года и пользователя
let selectedYearValue = document
	.getElementById('selected_year')
	.textContent.trim();
let selectedUserValue = document
	.getElementById('selected_user')
	.textContent.trim();

// Для года
const selectedYear = document.getElementById('selected_year');
const yearDropdown = document.getElementById('year_dropdown');
const yearList = document.getElementById('year_list');
const yearSelect = document.getElementById('outbound-year_select');
const arrowYear = document.getElementById('year_select-arrow');

// Открытие/закрытие дропдауна года
function closeYearDropdown() {
	yearDropdown.classList.remove('active');
	arrowYear.style.transform = 'rotate(0deg)';
}

function openYearDropdown() {
	yearDropdown.classList.add('active');
	arrowYear.style.transform = 'rotate(180deg)';
}

yearSelect.addEventListener('click', e => {
	// Проверяем наличие класса "active"
	if (yearDropdown.classList.contains('active')) {
		closeYearDropdown();
	} else {
		openYearDropdown();
	}
	e.stopPropagation(); // Блокируем всплытие события
});

// Добавляем года в список
for (let year = 2025; year >= 2018; year--) {
	const listItem = document.createElement('li');
	listItem.textContent = year;
	listItem.addEventListener('click', () => {
		selectedYear.textContent = year; // Устанавливаем выбранный год
		selectedYearValue = year; // Обновляем глобальную переменную
		closeYearDropdown(); // Закрываем dropdown
		buildTable(); // Перерендериваем таблицу с новыми данными
	});

	yearList.appendChild(listItem);
}

// Закрытие dropdown при клике вне
document.addEventListener('click', e => {
	if (!e.target.closest('#outbound-year_select')) {
		closeYearDropdown();
	}
});

// Блокировка всплытия события на dropdown
yearDropdown.addEventListener('click', e => {
	e.stopPropagation();
});

// Для пользователя
const selectedUser = document.getElementById('selected_user');
const userDropdown = document.getElementById('user_dropdown');
const userList = document.getElementById('user_list');
const userSelect = document.getElementById('outbound-user_select');
const arrowUsers = document.getElementById('user_select-arrow');

// Открытие/закрытие дропдауна пользователя
function closeUserDropdown() {
	userDropdown.classList.remove('active');
	arrowUsers.style.transform = 'rotate(0deg)';
}

function openUserDropdown() {
	userDropdown.classList.add('active');
	arrowUsers.style.transform = 'rotate(180deg)';
}

userSelect.addEventListener('click', e => {
	// Проверяем наличие класса "active"
	if (userDropdown.classList.contains('active')) {
		closeUserDropdown();
	} else {
		openUserDropdown();
	}
	e.stopPropagation(); // Блокируем всплытие события
});

// Добавляем пользователей в список из jsonData
jsonData.users.forEach(user => {
	const listItem = document.createElement('li');
	listItem.textContent = user.user; // Используем поле 'user' для имени пользователя
	listItem.addEventListener('click', () => {
		selectedUser.textContent = user.user; // Устанавливаем выбранного пользователя
		selectedUserValue = user.user; // Обновляем глобальную переменную
		closeUserDropdown(); // Закрываем dropdown
		buildTable(); // Перерендериваем таблицу с новыми данными
	});

	userList.appendChild(listItem);
});

// Закрытие dropdown при клике вне
document.addEventListener('click', e => {
	if (!e.target.closest('#outbound-user_select')) {
		closeUserDropdown();
	}
});

// Блокировка всплытия события на dropdown
userDropdown.addEventListener('click', e => {
	e.stopPropagation();
});

// Для таблицы
const table = document.getElementById('data-table');
const months = [
	'Jan',
	'Feb',
	'Mar',
	'Apr',
	'May',
	'Jun',
	'Jul',
	'Aug',
	'Sep',
	'Oct',
	'Nov',
	'Dec',
];

const daysInMonth = {
	jan: 31,
	feb: 28,
	mar: 31,
	apr: 30,
	may: 31,
	jun: 30,
	jul: 31,
	aug: 31,
	sep: 30,
	oct: 31,
	nov: 30,
	dec: 31,
};

// Функция для редактирования ячейки
function editCell(cell, day, month, userData) {
	const oldValue = cell.textContent;

	// Создаем инпут для редактирования
	const input = document.createElement('input');
	input.classList.add('change_input'); // Добавлен кастомный класс
	input.type = 'tel';
	input.max = 999; // Устанавливаем максимальное значение
	input.value = oldValue;
	cell.innerHTML = ''; // Очищаем ячейку
	cell.appendChild(input);

	// Фокусируемся на инпуте
	input.focus();

	// Ограничиваем ввод значением не больше 999
	input.addEventListener('input', () => {
		let value = input.value;
		if (value > 999) {
			input.value = 999;
		} else if (value < 0) {
			input.value = 0;
		}
	});

	// Сохраняем новое значение при потере фокуса
	input.addEventListener('blur', () => {
		let newValue = input.value;

		// Если значение пустое, сохраняем как 0
		if (newValue === '') {
			newValue = '0';
		}

		if (newValue !== oldValue) {
			saveData(day, month, newValue, userData); // Сохраняем данные
		}

		console.log(jsonData);

		// Восстанавливаем содержимое ячейки
		cell.textContent = newValue;
	});

	// Сохраняем при нажатии Enter
	input.addEventListener('keydown', e => {
		if (e.key === 'Enter') {
			let newValue = input.value;

			// Если значение пустое, сохраняем как 0
			if (newValue === '') {
				newValue = '0';
			}

			if (newValue > 999) {
				newValue = '999';
			}

			if (newValue !== oldValue) {
				saveData(day, month, newValue, userData); // Сохраняем данные
			}

			cell.textContent = newValue;
		}
	});
}

// Функция для сохранения данных
function saveData(day, month, value, userData) {
	const yearKey = `year_${selectedYearValue}`; // Строим ключ для года
	if (!userData.data[yearKey]) {
		console.error(`Нет данных для года ${selectedYearValue}`);
		return;
	}

	// Обновляем значение в данных пользователя
	const monthKey = month.toLowerCase();
	const data = userData.data[yearKey][monthKey] || [];
	data[day - 1] = parseFloat(value);

	// Теперь нужно перерендерить таблицу
	buildTable(); // Перерисовываем таблицу с обновленными данными
	console.log('Данные обновлены:', userData);
}

// Функция для построения таблицы
function buildTable() {
	// Очищаем таблицу перед ререндером
	const tbody = document.querySelector('#data-table tbody');
	tbody.innerHTML = '';

	// Перебираем дни месяца
	for (let day = 1; day <= 31; day++) {
		const row = document.createElement('tr');
		row.classList.add('row-hover'); // Добавляем класс для строки

		const dayCell = document.createElement('td');
		dayCell.textContent = day;
		dayCell.classList.add('day-cell'); // Добавляем класс для ячейки с днем
		row.appendChild(dayCell);

		let total = 0; // Для хранения суммы всех месяцев

		const userData = jsonData.users.find(
			user => user.user === selectedUserValue
		);

		if (!userData) {
			console.error('Пользователь не найден!');
			return;
		}

		// Проверяем наличие данных для выбранного года
		const yearKey = `year_${selectedYearValue}`; // Строим ключ для года
		if (!userData.data[yearKey]) {
			console.error(
				`Нет данных для года ${selectedYearValue} у пользователя ${userData.user}`
			);
			return;
		}

		// Для каждого месяца
		for (const month in daysInMonth) {
			const monthKey = month.toLowerCase();
			const data = userData.data[yearKey][monthKey] || []; // Получаем данные по месяцу для выбранного года
			const cell = document.createElement('td');

			// Если день в месяце существует, показываем его значение, иначе 0
			const value = data[day - 1] !== undefined ? data[day - 1] : 0;
			total += value; // Добавляем значение в total
			cell.textContent = value;
			row.appendChild(cell);

			// Добавляем обработчик клика на ячейку
			cell.addEventListener('click', () =>
				editCell(cell, day, monthKey, userData)
			);
		}

		// Добавляем ячейку для суммы (Total) и применяем класс для стилизации
		const totalCell = document.createElement('td');
		totalCell.textContent = total;
		totalCell.classList.add('total-column');
		row.appendChild(totalCell);

		// Добавляем строку в таблицу
		tbody.appendChild(row);
	}

	// Функция для вычисления итогов и средних значений
	function calculateTotalsAndAverages() {
		const rows = document.querySelectorAll('tbody tr'); // Получаем все строки данных
		const totalRow = document.querySelector('.total-row');
		const averageRow = document.querySelector('.average-row');

		let monthlyTotals = Array(12).fill(0); // Массив для хранения сумм по месяцам
		let dailyCount = Array(12).fill(0); // Массив для подсчета дней (которые имеют данные) по месяцам
		let totalSum = 0; // Для хранения общей суммы всех значений (для нового столбца)

		// Пройдем по каждой строке и добавим данные в monthlyTotals
		rows.forEach(row => {
			const cells = row.querySelectorAll('td');
			for (let i = 1; i <= 12; i++) {
				const cellValue = parseFloat(cells[i].textContent) || 0; // Получаем значение и преобразуем в число
				monthlyTotals[i - 1] += cellValue; // Добавляем к месяцу
				if (cellValue > 0) {
					dailyCount[i - 1]++; // Если значение больше нуля, считаем день
				}
				totalSum += cellValue; // Добавляем значение в общую сумму
			}
		});

		// Заполняем строку Total
		monthlyTotals.forEach((total, index) => {
			totalRow.querySelectorAll('.total-month')[index].textContent =
				total.toLocaleString('en-US'); // Преобразуем с разделителем
		});

		// Заполняем строку Average
		monthlyTotals.forEach((total, index) => {
			const average = dailyCount[index] > 0 ? total / dailyCount[index] : 0;
			averageRow.querySelectorAll('.average-month')[index].textContent =
				average.toFixed(1);
		});

		// Заполняем новый столбец для Total (общая сумма по всей таблице)
		totalRow.querySelector('.total-column').textContent =
			totalSum.toLocaleString('en-US'); // Преобразуем с разделителем

		// Заполняем новый столбец для Average (среднее значение по всей таблице)
		const averageTotal = rows.length > 0 ? totalSum / rows.length : 0;
		averageRow.querySelector('.total-column').textContent =
			averageTotal.toFixed(1);
	}

	// Вызываем функцию для вычисления итогов и средних значений
	calculateTotalsAndAverages();
}

// Инициализация таблицы при загрузке
buildTable();
